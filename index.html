<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Care Center Form</title>
    <!-- Use the Inter font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-blue-50 flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Uploaded Image -->
    <img src="https://placehold.co/1200x400/8c8c8c/ffffff?text=Add+your+image+here" alt="Care Center Group" class="w-full max-w-2xl rounded-2xl shadow-xl mb-8">
    
    <!-- Instructions to add your own image -->
    <div class="w-full max-w-2xl mb-8 p-4 bg-gray-200 rounded-lg text-center text-gray-700">
        <p class="font-bold">To use your own image:</p>
        <ol class="list-decimal list-inside text-left mx-auto max-w-sm mt-2">
            <li>Find your image on the web and get its URL.</li>
            <li>Replace the URL in the `src` attribute of the `<img>` tag with your image's URL.</li>
            <li>For example, `<img src="YOUR_IMAGE_URL_HERE.jpg" alt="Care Center Group">`</li>
        </ol>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Care Center Information</h1>
        <p class="text-center text-gray-500 mb-8">Select a CMDCare, Pastor, and Care Center to view its details.</p>

        <!-- Display User ID to help with Firestore debugging -->
        <div id="userIdDisplay" class="mb-4 text-center text-xs text-gray-400">
            User ID: <span id="userIdValue" class="font-mono">Loading...</span>
        </div>

        <!-- Section to view past reports -->
        <div id="reportViewContainer" class="hidden mt-8 p-6 bg-gray-100 rounded-xl max-h-96 overflow-y-auto">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Past Reports</h2>
            <div id="reportsMessage" class="text-center text-gray-500 mb-4"></div>
            <table id="reportsTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CMDCare</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PastorCare</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Care Center</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attendance</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Reports will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="showFormBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hidden">
                Show Form
            </button>
            <button id="viewReportsBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
                View Past Reports
            </button>
        </div>

        <form id="careForm" class="space-y-6">

            <!-- CMDCare Dropdown -->
            <div class="relative group">
                <label for="cmdCare" class="block text-sm font-medium text-gray-700 mb-2">CMDCare</label>
                <select id="cmdCare" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    <option value="" selected disabled>Select CMDCare</option>
                </select>
            </div>

            <!-- PastorCare Dropdown -->
            <div class="relative group">
                <label for="pastorCare" class="block text-sm font-medium text-gray-700 mb-2">PastorCare</label>
                <select id="pastorCare" disabled class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <option value="" selected disabled>Select PastorCare</option>
                </select>
            </div>

            <!-- Care Center Name Dropdown -->
            <div class="relative group">
                <label for="careCenterName" class="block text-sm font-medium text-gray-700 mb-2">Care Center Name</label>
                <select id="careCenterName" disabled class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <option value="" selected disabled>Select Care Center Name</option>
                </select>
            </div>

            <!-- Address Display Area -->
            <div id="addressDisplay" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-xl transition-all duration-300 scale-95 opacity-0">
                <h3 class="text-xl font-semibold text-blue-800 mb-2">Care Center Address</h3>
                <p id="addressText" class="text-gray-700 text-lg break-words"></p>
            </div>
            
            <!-- New Fields -->
            <hr class="my-6 border-t border-gray-200" />

            <!-- Date of Meeting/Service -->
            <div class="relative group">
                <label for="meetingDate" class="block text-sm font-medium text-gray-700 mb-2">Date of Meeting/Service</label>
                <input type="date" id="meetingDate" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
            </div>

            <!-- Report Week -->
            <div class="relative group">
                <label for="reportWeek" class="block text-sm font-medium text-gray-700 mb-2">Report Week</label>
                <select id="reportWeek" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    <option value="" selected disabled>Select week</option>
                    <option value="Week 1">Week 1</option>
                    <option value="Week 2">Week 2</option>
                    <option value="Week 3">Week 3</option>
                    <option value="Week 4">Week 4</option>
                    <option value="Week 5">Week 5</option>
                </select>
            </div>

            <!-- Attendance Numbers -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <div class="relative group">
                    <label for="maleCount" class="block text-sm font-medium text-gray-700 mb-2">Male</label>
                    <input type="number" id="maleCount" min="0" value="0" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>
                <div class="relative group">
                    <label for="femaleCount" class="block text-sm font-medium text-gray-700 mb-2">Female</label>
                    <input type="number" id="femaleCount" min="0" value="0" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>
                <div class="relative group">
                    <label for="childrenCount" class="block text-sm font-medium text-gray-700 mb-2">Children</label>
                    <input type="number" id="childrenCount" min="0" value="0" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>
            </div>

            <!-- Other Numbers -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div class="relative group">
                    <label for="mvpPresent" class="block text-sm font-medium text-gray-700 mb-2">MVP Present</label>
                    <input type="number" id="mvpPresent" min="0" value="0" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>
                <div class="relative group">
                    <label for="soulsWon" class="block text-sm font-medium text-gray-700 mb-2">Soul Won</label>
                    <input type="number" id="soulsWon" min="0" value="0" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>
            </div>

            <!-- Offering -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <div class="relative group">
                    <label for="offeringCash" class="block text-sm font-medium text-gray-700 mb-2">Offering (Cash)</label>
                    <input type="number" id="offeringCash" min="0" value="0" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>
                <div class="relative group">
                    <label for="offeringTransfer" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">Offering (Transfer)</label>
                    <input type="number" id="offeringTransfer" min="0" value="0" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                </div>
            </div>

            <!-- Treasurer -->
            <div class="relative group">
                <label for="treasurer" class="block text-sm font-medium text-gray-700 mb-2">Treasurer / Handling Cash</label>
                <input type="text" id="treasurer" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
            </div>

            <!-- Goals -->
            <div class="relative group">
                <label for="goals" class="block text-sm font-medium text-gray-700 mb-2">Goals for the next meeting</label>
                <textarea id="goals" rows="3" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300"></textarea>
            </div>

            <!-- Did you meet your GOALS? -->
            <div class="relative group">
                <label for="metGoals" class="block text-sm font-medium text-gray-700 mb-2">Did you meet your GOALS for the week?</label>
                <select id="metGoals" class="block w-full px-4 py-2 text-base text-gray-900 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-300">
                    <option value="" selected disabled>Select an option</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                    <option value="Partially">Partially</option>
                </select>
            </div>
            
            <!-- Submit Button -->
            <button type="submit" class="w-full mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all duration-300">
                Submit Report
            </button>
        </form>

        <!-- New section to display submitted data -->
        <div id="submissionMessage" class="hidden mt-8 p-6 bg-green-100 border border-green-300 rounded-xl">
            <h3 class="text-xl font-semibold text-green-800 mb-2">Report Submitted Successfully!</h3>
            <p id="submissionDetails" class="text-gray-700 text-sm break-words"></p>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global variables provided by the Canvas environment for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Authenticate the user and listen for state changes
        let userId;
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userIdValue').textContent = userId;
                console.log("User authenticated successfully with UID:", userId);
            } else {
                console.log("No user is signed in. Signing in anonymously...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during authentication:", error);
                    document.getElementById('userIdValue').textContent = "Error";
                }
            }
        });
        
        // Data structure representing the provided information.
        // The data is organized hierarchically for easy access.
        const careData = {
            "Barr.Donald Ikebude (Cmd Over Achakpo/Ojo Road)": {
                "Ese Sese Atina": {
                    "House Of Peace 1": "Geouey",
                    "House Of Peace 2": "79 Goriola Street"
                },
                "Miss Mary Peter": {
                    "Spring Of Light": "55 Iyalode Street",
                    "Spring Of Light Care Center": "54 Iyalode Street Ajegunle"
                },
                "Chukwu Chisom": {
                    "Ojo Road Cell Branch Two": "17 Agbeke Street, Off Ojo Road",
                    "Ojo Road Cell Division 2": "17 Agbeke Street Ojo Road"
                },
                "Clara Nkwocha": {
                    "Shammah'S House Care Centre": "30/80 Uzor Street",
                    "Shammah’S House": "30/80 Uzor Street"
                },
                "Christian Edoziem": {
                    "Glorious Cell": "61 Mba Street",
                    "Glorious Cell at Ajegunle": "61 Mba Street Ajegunle Apapa Lagos"
                },
                "Misheal Nwobodo": {
                    "Bethel 1": "54 Uzor Street"
                },
                "Mary Peter": {
                    "Spring Of Light": "54 Iyalode"
                },
                "Ebube Paul": {
                    "Bethel 2": "143 Uzor"
                },
                "Winner Jack": {
                    "Ojo Road Care Center": "50 Ojo Road"
                },
                "Rachael Etinagbedia": {
                    "House Of Peace 1": "29B, Aduba Close, Off Peter Street"
                },
                "Frank Anasonwu": {
                    "Glory Cell": "23 Opaleye Street"
                }
            },
            "Chikodi Okorie (Cmd Over Oregie)": {
                "Chikodi Okorie": {
                    "Goshen Care Centre": "80, Uzor Street, Ajegunle, Lagos",
                    "Goshen 1": "80 Uzor Street Ajegunle"
                },
                "Prosper Ogbuja": {
                    "Yahweh": "181B Uzor Street",
                    "Goshen": "80 Uzor Street"
                },
                "Precious Nwafor": {
                    "Grace Haven": "Bethel Place Beside Rolex School"
                },
                "Samson Onukurefe": {
                    "Citadel Care Center": "84,Uzor Street",
                    "Citadel": "84 Uzor Street"
                },
                "Gabriel Jimoh": {
                    "Lionstribe": "16 Canal Road Oriege"
                },
                "Blessing Bartholomew": {
                    "Koinonia Care Center": "3 Otakoya Street",
                    "Koinonia": "3 Otakoya Street"
                },
                "Ebuka Ogbuja": {
                    "Goshen 2": "46, Taiwo Street"
                }
            },
            "Pst. Martins Ogbuja (Cmd Over Tolu/Ajasa)": {
                "Daniella Edeh": {
                    "Engraced Tribe": "53, Taiwo Street"
                },
                "Godswill Nwosu": {
                    "Oasis Cell": "13 College Road"
                },
                "Gabriel Anthony": {
                    "God'S Breed": "69 Fasasi Street Olodi-Apapa",
                    "God'S Breed Care Centre": "69 Fasasi Street Olodi-Apapa Lagos"
                },
                "Naomi Echefu": {
                    "Peniel": "03 Ladega",
                    "Peniel at Ladega": "3 Ladega Street"
                },
                "Wisdom Anyia": {
                    "Krainos Care Center": "No 32 Idi Street",
                    "Kainos": "20 Idi Street Ajegunle Apapa Lagos"
                },
                "Daniel Utodio": {
                    "David'S Tribe": "34, Olowosu Street",
                    "David'S Tribe at Olowosu": "34 Olowosu Street"
                },
                "Nnabuihe Bright Ihuoma": {
                    "House Of Prayer": "64 Lawani Street Olodi Apapa Lagos"
                },
                "Arinze Ifeanyi": {
                    "God’S Power House": "1 Layode Street"
                }
            },
            "P. Rita Iheanyi (Cmd Over Ago/Bucknor)": {
                "Nzekwe Kingsley": {
                    "Bucknor": "2 Ifechukwu Street Bocknor"
                },
                "Sis Ngozi": {
                    "Overcomers": "No 6 Ladisa Crescent, Apple Estate, Amuwo Odofin"
                }
            },
            "P.Joshua Kelechi (Cmd Over Wilmer/Coconut)": {
                "BlessingAkogwu": {
                    "Akogun Street": "Akogun Street"
                },
                "Success Akanno": {
                    "Holy Nation": "39 Ben Onyeka Street",
                    "Gospel World": "13 Briemo Street"
                },
                "Moses Anthony": {
                    "Shining Light": "21 Salawu Street",
                    "Shinning Light": "21 Salawu Street"
                },
                "Kosi Paul": {
                    "Hassanah Cell 2": "25 Babatunde Street",
                    "Hosannah Cell 2": "32 Babatunde"
                },
                "Michael Iheakachi": {
                    "Hosanna Cell": "10 Jones Waribi Street"
                },
                "Faith Joseph": {
                    "Holy Nation": "39, Ben Onyeka Street"
                }
            }
        };

        // Get DOM elements
        const careForm = document.getElementById('careForm');
        const cmdCareSelect = document.getElementById('cmdCare');
        const pastorCareSelect = document.getElementById('pastorCare');
        const careCenterNameSelect = document.getElementById('careCenterName');
        const addressDisplay = document.getElementById('addressDisplay');
        const addressText = document.getElementById('addressText');
        const submissionMessage = document.getElementById('submissionMessage');
        const submissionDetails = document.getElementById('submissionDetails');
        const reportViewContainer = document.getElementById('reportViewContainer');
        const reportsMessage = document.getElementById('reportsMessage');
        const reportsTableBody = document.getElementById('reportsTableBody');
        const showFormBtn = document.getElementById('showFormBtn');
        const viewReportsBtn = document.getElementById('viewReportsBtn');

        // Function to populate a dropdown with options
        function populateDropdown(selectElement, options) {
            // Clear existing options
            selectElement.innerHTML = '';
            // Add a default placeholder option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = `Select ${selectElement.previousElementSibling.textContent}`;
            defaultOption.disabled = true;
            defaultOption.selected = true;
            selectElement.appendChild(defaultOption);

            // Add new options from the provided array
            options.forEach(option => {
                const newOption = document.createElement('option');
                newOption.value = option;
                newOption.text = option;
                selectElement.appendChild(newOption);
            });
            // Re-enable the dropdown
            selectElement.disabled = false;
        }
        
        // Function to fetch and display past reports
        async function fetchAndDisplayReports() {
            if (!userId) {
                reportsMessage.textContent = "Authentication in progress. Please wait...";
                return;
            }

            reportsMessage.textContent = "Loading reports...";
            reportsTableBody.innerHTML = ''; // Clear previous data
            reportViewContainer.classList.remove('hidden');
            careForm.classList.add('hidden');
            showFormBtn.classList.remove('hidden');
            viewReportsBtn.classList.add('hidden');
            submissionMessage.classList.add('hidden');
            
            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/form-submissions`;
                const q = query(collection(db, collectionPath));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    reportsMessage.textContent = "No reports found. Submit a report to see it here.";
                } else {
                    reportsMessage.textContent = "";
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const totalAttendance = data.maleCount + data.femaleCount + data.childrenCount;
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-100 transition-colors duration-200';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.meetingDate || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.cmdCare || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.pastorCare || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.careCenterName || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${totalAttendance}</td>
                        `;
                        reportsTableBody.appendChild(row);
                    });
                }
            } catch (e) {
                console.error("Error fetching documents: ", e);
                reportsMessage.textContent = "Error loading reports. Please try again later.";
            }
        }

        // --- Event Listeners ---
        
        // Fix: Populating the CMDCare dropdown immediately on script load.
        // This is a more reliable way to ensure the dropdown is ready when the page is displayed.
        const cmdCareOptions = Object.keys(careData);
        populateDropdown(cmdCareSelect, cmdCareOptions);
        
        // 1. Listen for changes on the CMDCare dropdown
        cmdCareSelect.addEventListener('change', (e) => {
            const selectedCmdCare = e.target.value;
            // Get the pastors for the selected CMDCare
            const pastorOptions = Object.keys(careData[selectedCmdCare]);
            // Populate the next dropdown
            populateDropdown(pastorCareSelect, pastorOptions);
            
            // Reset subsequent dropdowns and address display
            careCenterNameSelect.innerHTML = '<option value="" selected disabled>Select Care Center Name</option>';
            careCenterNameSelect.disabled = true;
            addressDisplay.classList.remove('scale-100', 'opacity-100');
            addressDisplay.classList.add('scale-95', 'opacity-0');
        });

        // 2. Listen for changes on the PastorCare dropdown
        pastorCareSelect.addEventListener('change', (e) => {
            const selectedCmdCare = cmdCareSelect.value;
            const selectedPastor = e.target.value;
            
            // Get the care center names for the selected Pastor
            const careCenterOptions = Object.keys(careData[selectedCmdCare][selectedPastor]);
            // Populate the next dropdown
            populateDropdown(careCenterNameSelect, careCenterOptions);
            
            // Reset address display
            addressDisplay.classList.remove('scale-100', 'opacity-100');
            addressDisplay.classList.add('scale-95', 'opacity-0');
        });

        // 3. Listen for changes on the Care Center Name dropdown
        careCenterNameSelect.addEventListener('change', (e) => {
            const selectedCmdCare = cmdCareSelect.value;
            const selectedPastor = pastorCareSelect.value;
            const selectedCareCenter = e.target.value;
            
            // Get the address for the selected Care Center
            const address = careData[selectedCmdCare][selectedPastor][selectedCareCenter];
            
            // Display the address
            addressText.textContent = address;
            addressDisplay.classList.remove('scale-95', 'opacity-0');
            addressDisplay.classList.add('scale-100', 'opacity-100');
        });
        
        // 4. Add a submit event listener to the form to handle data submission
        careForm.addEventListener('submit', async (e) => {
            // Prevent the default form submission behavior (reloading the page)
            e.preventDefault();

            // Collect all form data into an object
            const formData = {
                cmdCare: cmdCareSelect.value,
                pastorCare: pastorCareSelect.value,
                careCenterName: careCenterNameSelect.value,
                address: addressText.textContent,
                meetingDate: document.getElementById('meetingDate').value,
                reportWeek: document.getElementById('reportWeek').value,
                maleCount: parseInt(document.getElementById('maleCount').value, 10),
                femaleCount: parseInt(document.getElementById('femaleCount').value, 10),
                childrenCount: parseInt(document.getElementById('childrenCount').value, 10),
                mvpPresent: parseInt(document.getElementById('mvpPresent').value, 10),
                soulsWon: parseInt(document.getElementById('soulsWon').value, 10),
                offeringCash: parseInt(document.getElementById('offeringCash').value, 10),
                offeringTransfer: parseInt(document.getElementById('offeringTransfer').value, 10),
                treasurer: document.getElementById('treasurer').value,
                goals: document.getElementById('goals').value,
                metGoals: document.getElementById('metGoals').value,
                // Add a timestamp to the data
                timestamp: new Date().toISOString()
            };
            
            // Check if user is authenticated before saving
            if (!userId) {
                console.error("User not authenticated. Data not saved to Firestore.");
                submissionDetails.innerHTML = `<p class="text-red-500">Error: User not authenticated. Please try refreshing the page.</p>`;
                submissionMessage.classList.remove('hidden');
                return;
            }

            try {
                // Construct the Firestore path for the new document
                const collectionPath = `artifacts/${appId}/users/${userId}/form-submissions`;
                
                // Add the new document to the collection
                const docRef = await addDoc(collection(db, collectionPath), formData);
                
                console.log("Document successfully written with ID: ", docRef.id);

                // Update the submission message to include the Firestore document ID
                let detailsHtml = '<ul>';
                detailsHtml += `<li><strong>Document ID:</strong> ${docRef.id}</li>`;
                for (const key in formData) {
                    if (formData.hasOwnProperty(key)) {
                        const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, (str) => str.toUpperCase());
                        detailsHtml += `<li><strong>${label}:</strong> ${formData[key]}</li>`;
                    }
                }
                detailsHtml += '</ul>';

                submissionDetails.innerHTML = detailsHtml;
                submissionMessage.classList.remove('hidden');

                // Reset the form after successful submission
                careForm.reset();
                
            } catch (e) {
                console.error("Error adding document: ", e);
                submissionDetails.innerHTML = `<p class="text-red-500">Error: Failed to save report. Please check the console for details.</p>`;
                submissionMessage.classList.remove('hidden');
            }
        });

        // 5. Handle button clicks to switch between form and reports view
        viewReportsBtn.addEventListener('click', fetchAndDisplayReports);
        
        showFormBtn.addEventListener('click', () => {
            reportViewContainer.classList.add('hidden');
            careForm.classList.remove('hidden');
            showFormBtn.classList.add('hidden');
            viewReportsBtn.classList.remove('hidden');
            submissionMessage.classList.add('hidden');
        });

    </script>

</body>
</html>
